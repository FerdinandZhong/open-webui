{% extends "base.html" %}

{% block content %}
<!-- Compact Modern Search Section -->
<div class="search-hero">
    <div class="search-hero-content">
        <div class="search-badges">
            <span class="hero-badge traditional">üìä Traditional</span>
            <span class="hero-badge-vs">vs</span>
            <span class="hero-badge llm">ü§ñ AI-Powered</span>
        </div>
        <h1 class="search-hero-title">SDN Watchlist Screening</h1>
        <p class="search-hero-subtitle">Compare rule-based feature extraction with AI-powered analysis</p>
    </div>

    <form id="search-form" class="search-bar-container">
        <div class="search-input-wrapper">
            <svg class="search-icon" viewBox="0 0 24 24" width="20" height="20">
                <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2" fill="none"/>
                <path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <input
                type="text"
                id="query"
                name="query"
                class="search-input"
                placeholder="Enter name, DOB, nationality... (e.g., John Smith, 01/15/1980, USA)"
                required
                autocomplete="off"
            >
            <div class="search-options">
                <label class="results-label" for="max_results">Max:</label>
                <select id="max_results" name="max_results" class="results-select">
                    <option value="5">5</option>
                    <option value="10" selected>10</option>
                    <option value="20">20</option>
                    <option value="50">50</option>
                </select>
            </div>
            <button type="submit" class="search-submit" id="search-btn">
                <span class="btn-text">Screen</span>
                <span class="spinner" style="display: none;"></span>
            </button>
        </div>
    </form>

    <!-- Inline Progress -->
    <div id="progress-section" class="progress-inline" style="display: none;">
        <div class="progress-bar-container">
            <div class="progress-bar-fill" id="progress-bar"></div>
        </div>
        <div class="progress-status">
            <span class="progress-icon">‚è≥</span>
            <span class="progress-text" id="progress-text">Analyzing...</span>
        </div>
    </div>
</div>

<!-- Side-by-Side Results Section -->
<div id="results-section" class="results-section" style="display: none;">
    <div class="comparison-container">
        <!-- LEFT SIDE: Traditional Method -->
        <div class="method-panel traditional-panel">
            <div class="method-header">
                <div class="method-title">
                    <span class="method-icon">üìä</span>
                    <h3>Traditional Feature-Based</h3>
                </div>
                <span class="method-badge traditional">Rule-Based</span>
            </div>

            <div class="method-description">
                Uses 21 extracted features including Levenshtein distance, Jaro-Winkler similarity,
                Soundex, n-gram matching, DOB/nationality matching, and more.
            </div>

            <!-- Feature Summary -->
            <div class="feature-summary" id="traditional-summary">
                <div class="summary-stat">
                    <span class="stat-value" id="trad-total-features">21</span>
                    <span class="stat-label">Features Analyzed</span>
                </div>
                <div class="summary-stat">
                    <span class="stat-value" id="trad-matches">0</span>
                    <span class="stat-label">Matches Found</span>
                </div>
            </div>

            <!-- Traditional Results -->
            <div class="method-results" id="traditional-results">
                <p class="no-results">Run a search to see results</p>
            </div>
        </div>

        <!-- RIGHT SIDE: LLM Method -->
        <div class="method-panel llm-panel">
            <div class="method-header">
                <div class="method-title">
                    <span class="method-icon">ü§ñ</span>
                    <h3>AI-Powered (LLM)</h3>
                </div>
                <span class="method-badge llm">AI Enhanced</span>
            </div>

            <div class="method-description">
                Uses LLM for intelligent name variation generation, contextual analysis,
                and nuanced confidence scoring with detailed explanations.
            </div>

            <!-- LLM Pipeline Summary -->
            <div class="pipeline-summary" id="llm-summary">
                <div class="summary-stat">
                    <span class="stat-value" id="llm-variations">0</span>
                    <span class="stat-label">Name Variations</span>
                </div>
                <div class="summary-stat">
                    <span class="stat-value" id="llm-matches">0</span>
                    <span class="stat-label">Matches Found</span>
                </div>
            </div>

            <!-- LLM Pipeline Details (Collapsible) -->
            <div class="pipeline-toggle">
                <button class="btn-toggle-pipeline" onclick="toggleLLMPipeline()">
                    <span>View Pipeline Details</span>
                    <svg class="chevron" viewBox="0 0 24 24" width="16" height="16">
                        <path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" fill="none"/>
                    </svg>
                </button>
            </div>

            <div class="llm-pipeline-details" id="llm-pipeline-details" style="display: none;">
                <!-- Step 1: Name Generation -->
                <div class="pipeline-mini-step">
                    <div class="mini-step-header" onclick="toggleMiniStep('llm-step1')">
                        <span class="mini-step-icon">ü§ñ</span>
                        <span class="mini-step-title">Step 1: AI Name Generation</span>
                        <span class="mini-step-count" id="llm-step1-count">0 variations</span>
                    </div>
                    <div class="mini-step-body" id="llm-step1-body">
                        <div class="variations-cloud" id="llm-step1-variations"></div>
                    </div>
                </div>

                <!-- Step 2: Database Filtering -->
                <div class="pipeline-mini-step">
                    <div class="mini-step-header" onclick="toggleMiniStep('llm-step2')">
                        <span class="mini-step-icon">üîç</span>
                        <span class="mini-step-title">Step 2: Database Filtering</span>
                        <span class="mini-step-count" id="llm-step2-count">0 matches</span>
                    </div>
                    <div class="mini-step-body" id="llm-step2-body">
                        <div class="matches-list" id="llm-step2-matches"></div>
                    </div>
                </div>

                <!-- Step 3: AI Ranking -->
                <div class="pipeline-mini-step">
                    <div class="mini-step-header" onclick="toggleMiniStep('llm-step3')">
                        <span class="mini-step-icon">‚öñÔ∏è</span>
                        <span class="mini-step-title">Step 3: AI Ranking</span>
                        <span class="mini-step-count" id="llm-step3-count">0 ranked</span>
                    </div>
                    <div class="mini-step-body" id="llm-step3-body">
                        <div class="ranking-cards" id="llm-step3-ranking"></div>
                    </div>
                </div>
            </div>

            <!-- LLM Results -->
            <div class="method-results" id="llm-results">
                <p class="no-results">Run a search to see results</p>
            </div>
        </div>
    </div>
</div>

<div id="error-section" class="error-section" style="display: none;">
    <div class="error-message" id="error-message"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Store data globally
let currentData = null;
let progressInterval = null;

document.getElementById('search-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const query = document.getElementById('query').value;
    const maxResults = document.getElementById('max_results').value;
    const searchBtn = document.getElementById('search-btn');
    const resultsSection = document.getElementById('results-section');
    const errorSection = document.getElementById('error-section');
    const progressSection = document.getElementById('progress-section');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');

    // Show loading state
    searchBtn.disabled = true;
    searchBtn.querySelector('.btn-text').style.display = 'none';
    searchBtn.querySelector('.spinner').style.display = 'inline-block';
    resultsSection.style.display = 'none';
    errorSection.style.display = 'none';
    progressSection.style.display = 'flex';

    // Animate progress bar
    let progress = 0;
    const messages = [
        'Extracting features...',
        'Running traditional analysis...',
        'Generating AI name variations...',
        'Analyzing with AI...',
        'Ranking matches...',
        'Finalizing results...'
    ];
    let msgIndex = 0;

    progressBar.style.width = '0%';
    progressInterval = setInterval(() => {
        progress += Math.random() * 15;
        if (progress > 90) progress = 90;
        progressBar.style.width = progress + '%';
        if (progress > msgIndex * 15 && msgIndex < messages.length) {
            progressText.textContent = messages[msgIndex];
            msgIndex++;
        }
    }, 300);

    try {
        const response = await fetch('/search', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ query, max_results: parseInt(maxResults) })
        });

        const data = await response.json();
        clearInterval(progressInterval);

        if (response.ok) {
            currentData = data;
            progressBar.style.width = '100%';
            progressText.textContent = 'Complete!';

            setTimeout(() => {
                displayTraditionalResults(data.traditional);
                displayLLMResults(data);
                resultsSection.style.display = 'block';
                progressSection.style.display = 'none';
            }, 300);
        } else {
            progressBar.style.background = 'var(--danger-color)';
            progressText.textContent = 'Error occurred';
            showError(data.error || 'An error occurred');
        }
    } catch (error) {
        clearInterval(progressInterval);
        progressBar.style.background = 'var(--danger-color)';
        progressText.textContent = 'Connection failed';
        showError('Network error: Unable to connect to server');
    } finally {
        searchBtn.disabled = false;
        searchBtn.querySelector('.btn-text').style.display = 'inline';
        searchBtn.querySelector('.spinner').style.display = 'none';
    }
});

// Display Traditional Method Results
function displayTraditionalResults(traditional) {
    if (!traditional) {
        document.getElementById('traditional-results').innerHTML = '<p class="no-results">Traditional method not available</p>';
        return;
    }

    // Update summary stats
    document.getElementById('trad-matches').textContent = traditional.total_matches || 0;
    document.getElementById('trad-total-features').textContent = traditional.step_details?.total_features || 21;

    const container = document.getElementById('traditional-results');

    if (!traditional.results || traditional.results.length === 0) {
        container.innerHTML = '<p class="no-results">No matches found</p>';
        return;
    }

    container.innerHTML = traditional.results.map(match => `
        <div class="result-card traditional-result ${getConfidenceClass(match.confidence)}">
            <div class="result-header">
                <h4 class="result-name">${escapeHtml(match.name)}</h4>
                <span class="confidence-badge ${getConfidenceClass(match.confidence)}">
                    ${match.confidence} (${(match.score * 100).toFixed(0)}%)
                </span>
            </div>

            <div class="result-meta">
                <span class="meta-item"><strong>Type:</strong> ${match.type}</span>
                <span class="meta-item"><strong>Features Matched:</strong> ${match.feature_count}/21</span>
            </div>

            <!-- Feature Breakdown -->
            <div class="feature-breakdown">
                <div class="feature-breakdown-header" onclick="toggleFeatures(this)">
                    <span>üìä Feature Analysis</span>
                    <svg class="chevron" viewBox="0 0 24 24" width="16" height="16">
                        <path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" fill="none"/>
                    </svg>
                </div>
                <div class="feature-breakdown-body" style="display: none;">
                    <div class="feature-grid">
                        ${Object.entries(match.features || {}).map(([key, value]) => `
                            <div class="feature-item ${value > 0.5 ? 'high' : value > 0.2 ? 'medium' : 'low'}">
                                <span class="feature-name">${formatFeatureName(key)}</span>
                                <span class="feature-value">${(value * 100).toFixed(0)}%</span>
                                <div class="feature-bar">
                                    <div class="feature-bar-fill" style="width: ${value * 100}%"></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>

            ${match.details.dob ? `<p class="detail-item"><strong>DOB:</strong> ${match.details.dob}</p>` : ''}
            ${match.details.nationality ? `<p class="detail-item"><strong>Nationality:</strong> ${match.details.nationality}</p>` : ''}
        </div>
    `).join('');
}

// Display LLM Method Results
function displayLLMResults(data) {
    // Update summary stats
    const stepDetails = data.step_details || {};
    document.getElementById('llm-variations').textContent = stepDetails.step1_name_generation?.variation_count || 0;
    document.getElementById('llm-matches').textContent = data.total_matches || 0;

    // Populate pipeline details
    populateLLMPipeline(stepDetails);

    const container = document.getElementById('llm-results');

    if (!data.results || data.results.length === 0) {
        container.innerHTML = '<p class="no-results">No matches found</p>';
        return;
    }

    container.innerHTML = data.results.map(match => `
        <div class="result-card llm-result ${getConfidenceClass(match.confidence)}">
            <div class="result-header">
                <h4 class="result-name">${escapeHtml(match.name)}</h4>
                <span class="confidence-badge ${getConfidenceClass(match.confidence)}">
                    ${match.confidence} (${(match.llm_score * 100).toFixed(0)}%)
                </span>
            </div>

            <div class="result-meta">
                <span class="meta-item"><strong>Type:</strong> ${match.type}</span>
                <span class="meta-item"><strong>Name Match:</strong> ${(match.name_match_score * 100).toFixed(0)}%</span>
            </div>

            ${match.explanation ? `
                <div class="llm-explanation">
                    <div class="explanation-header" onclick="toggleExplanation(this)">
                        <span>ü§ñ AI Analysis</span>
                        <svg class="chevron" viewBox="0 0 24 24" width="16" height="16">
                            <path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" fill="none"/>
                        </svg>
                    </div>
                    <div class="explanation-body" style="display: none;">
                        <pre>${escapeHtml(match.explanation)}</pre>
                    </div>
                </div>
            ` : ''}

            <div class="match-reasons">
                ${(match.match_reasons || []).map(reason =>
                    `<span class="reason-tag">${escapeHtml(reason)}</span>`
                ).join('')}
            </div>

            ${match.details.dob ? `<p class="detail-item"><strong>DOB:</strong> ${match.details.dob}</p>` : ''}
            ${match.details.nationality ? `<p class="detail-item"><strong>Nationality:</strong> ${match.details.nationality}</p>` : ''}
        </div>
    `).join('');
}

// Populate LLM Pipeline Details
function populateLLMPipeline(stepDetails) {
    // Step 1: Variations
    const step1 = stepDetails.step1_name_generation;
    if (step1) {
        document.getElementById('llm-step1-count').textContent = `${step1.variation_count || 0} variations`;
        const varContainer = document.getElementById('llm-step1-variations');
        if (step1.variations && step1.variations.length > 0) {
            varContainer.innerHTML = step1.variations.map(v =>
                `<span class="variation-chip">${escapeHtml(v)}</span>`
            ).join('');
        }
    }

    // Step 2: Filtering
    const step2 = stepDetails.step2_database_filtering;
    if (step2) {
        document.getElementById('llm-step2-count').textContent = `${step2.matches_found || 0} matches`;
        const matchContainer = document.getElementById('llm-step2-matches');
        if (step2.matches && step2.matches.length > 0) {
            matchContainer.innerHTML = step2.matches.map(m => `
                <div class="match-item">
                    <span class="match-item-name">${escapeHtml(m.name)}</span>
                    <span class="match-item-score">${(m.score * 100).toFixed(1)}%</span>
                </div>
            `).join('');
        }
    }

    // Step 3: Ranking
    const step3 = stepDetails.step3_ai_ranking;
    if (step3 && step3.ranking_details) {
        document.getElementById('llm-step3-count').textContent = `${step3.ranking_details.length} ranked`;
        const rankContainer = document.getElementById('llm-step3-ranking');
        if (step3.ranking_details.length > 0) {
            rankContainer.innerHTML = step3.ranking_details.map(r => `
                <div class="ranking-card mini">
                    <span class="ranking-name">${escapeHtml(r.name)}</span>
                    <span class="ranking-score">${(r.final_score * 100).toFixed(0)}%</span>
                    <span class="ranking-confidence ${getConfidenceClass(r.confidence)}">${r.confidence}</span>
                </div>
            `).join('');
        }
    }
}

// Toggle functions
function toggleLLMPipeline() {
    const details = document.getElementById('llm-pipeline-details');
    const btn = document.querySelector('.btn-toggle-pipeline');
    if (details.style.display === 'none') {
        details.style.display = 'block';
        btn.classList.add('expanded');
    } else {
        details.style.display = 'none';
        btn.classList.remove('expanded');
    }
}

function toggleMiniStep(stepId) {
    const body = document.getElementById(`${stepId}-body`);
    body.style.display = body.style.display === 'none' ? 'block' : 'none';
}

function toggleFeatures(element) {
    const body = element.nextElementSibling;
    const chevron = element.querySelector('.chevron');
    if (body.style.display === 'none') {
        body.style.display = 'block';
        chevron.style.transform = 'rotate(180deg)';
    } else {
        body.style.display = 'none';
        chevron.style.transform = 'rotate(0deg)';
    }
}

function toggleExplanation(element) {
    const body = element.nextElementSibling;
    const chevron = element.querySelector('.chevron');
    if (body.style.display === 'none') {
        body.style.display = 'block';
        chevron.style.transform = 'rotate(180deg)';
    } else {
        body.style.display = 'none';
        chevron.style.transform = 'rotate(0deg)';
    }
}

// Utility functions
function getConfidenceClass(confidence) {
    const level = (confidence || 'low').toLowerCase().replace('-', '_');
    return `confidence-${level}`;
}

function formatFeatureName(key) {
    return key.split('_').map(word =>
        word.charAt(0).toUpperCase() + word.slice(1)
    ).join(' ');
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showError(message) {
    const errorSection = document.getElementById('error-section');
    const errorMessage = document.getElementById('error-message');
    errorMessage.textContent = message;
    errorSection.style.display = 'block';
    document.getElementById('progress-section').style.display = 'none';
}
</script>
{% endblock %}
