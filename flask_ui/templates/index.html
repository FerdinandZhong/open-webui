{% extends "base.html" %}

{% block content %}
<div class="search-section">
    <h2 class="section-title">Search SDN Watchlist</h2>
    <p class="section-description">
        Enter name, date of birth, nationality, or other identifying information to search the OFAC SDN list.
    </p>
    
    <form id="search-form" class="search-form">
        <div class="form-group">
            <label for="query">Search Query</label>
            <textarea 
                id="query" 
                name="query" 
                class="form-control" 
                rows="3" 
                placeholder="Example: John Smith, 01/15/1980, USA"
                required
            ></textarea>
        </div>
        
        <div class="form-group">
            <label for="max_results">Maximum Results</label>
            <input 
                type="number" 
                id="max_results" 
                name="max_results" 
                class="form-control" 
                value="10" 
                min="1" 
                max="50"
            >
        </div>
        
        <button type="submit" class="btn btn-primary" id="search-btn">
            <span class="btn-text">Search</span>
            <span class="spinner" style="display: none;"></span>
        </button>
    </form>
    
    <!-- Progress Status Section -->
    <div id="progress-section" class="progress-section" style="display: none;">
        <h3>Search Progress</h3>
        <div class="progress-steps">
            <div class="progress-step" id="step-1">
                <span class="step-number">1</span>
                <span class="step-text">Generating name variations...</span>
                <span class="step-status">‚è≥</span>
            </div>
            <div class="progress-step" id="step-2">
                <span class="step-number">2</span>
                <span class="step-text">Filtering potential matches...</span>
                <span class="step-status">‚è≥</span>
            </div>
            <div class="progress-step" id="step-3">
                <span class="step-number">3</span>
                <span class="step-text">AI-powered ranking...</span>
                <span class="step-status">‚è≥</span>
            </div>
            <div class="progress-step" id="step-4">
                <span class="step-number">4</span>
                <span class="step-text">Generating explanations...</span>
                <span class="step-status">‚è≥</span>
            </div>
        </div>
    </div>
</div>

<div id="results-section" class="results-section" style="display: none;">
    <h3 class="results-title">Search Results</h3>
    
    <!-- Step Summary Section with Expandable Details -->
    <div id="step-summary" class="step-summary">
        <h4>Processing Summary</h4>
        <div class="summary-steps">
            <!-- Step 1: Name Generation -->
            <div class="summary-step expandable" id="step1-container">
                <div class="step-header" onclick="toggleStepDetails('step1')">
                    <span class="summary-icon">ü§ñ</span>
                    <div class="summary-content">
                        <strong>Step 1: AI Name Generation</strong>
                        <p id="summary-step1">Generated AI-powered name variations</p>
                    </div>
                    <span class="expand-icon" id="step1-expand-icon">‚ñº</span>
                </div>
                <div class="step-details" id="step1-details" style="display: none;">
                    <div class="details-content">
                        <h5>Generated Name Variations</h5>
                        <p class="details-description">These variations are used to find potential matches in the database:</p>
                        <div class="name-variations-list" id="step1-variations">
                            <!-- Name variations will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Database Filtering -->
            <div class="summary-step expandable" id="step2-container">
                <div class="step-header" onclick="toggleStepDetails('step2')">
                    <span class="summary-icon">üîç</span>
                    <div class="summary-content">
                        <strong>Step 2: Database Filtering</strong>
                        <p id="summary-step2">Searched through SDN entries</p>
                    </div>
                    <span class="expand-icon" id="step2-expand-icon">‚ñº</span>
                </div>
                <div class="step-details" id="step2-details" style="display: none;">
                    <div class="details-content">
                        <h5>Filtering Results</h5>
                        <div class="filter-stats" id="step2-stats">
                            <!-- Filter stats will be populated here -->
                        </div>
                        <h5>Initial Matches (Before AI Ranking)</h5>
                        <div class="filter-matches-table" id="step2-matches">
                            <!-- Matches table will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 3: AI Ranking -->
            <div class="summary-step expandable" id="step3-container">
                <div class="step-header" onclick="toggleStepDetails('step3')">
                    <span class="summary-icon">‚öñÔ∏è</span>
                    <div class="summary-content">
                        <strong>Step 3: AI Ranking & Scoring</strong>
                        <p id="summary-step3">Applied AI-powered confidence scoring</p>
                    </div>
                    <span class="expand-icon" id="step3-expand-icon">‚ñº</span>
                </div>
                <div class="step-details" id="step3-details" style="display: none;">
                    <div class="details-content">
                        <h5>AI Ranking Details</h5>
                        <p class="details-description">Each match is analyzed using contextual factors (DOB, nationality, etc.):</p>
                        <div class="ranking-table" id="step3-ranking">
                            <!-- Ranking details will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 4: Explanation Generation -->
            <div class="summary-step" id="step4-container">
                <div class="step-header">
                    <span class="summary-icon">üìù</span>
                    <div class="summary-content">
                        <strong>Step 4: Explanation Generation</strong>
                        <p id="summary-step4">Generated detailed match explanations</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="results-container"></div>
</div>

<div id="error-section" class="error-section" style="display: none;">
    <div class="error-message" id="error-message"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Store step details globally for expandable sections
let currentStepDetails = null;

document.getElementById('search-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const query = document.getElementById('query').value;
    const maxResults = document.getElementById('max_results').value;
    const searchBtn = document.getElementById('search-btn');
    const resultsSection = document.getElementById('results-section');
    const errorSection = document.getElementById('error-section');
    const progressSection = document.getElementById('progress-section');
    const resultsContainer = document.getElementById('results-container');

    // Show loading state and progress
    searchBtn.disabled = true;
    searchBtn.querySelector('.btn-text').style.display = 'none';
    searchBtn.querySelector('.spinner').style.display = 'inline-block';
    resultsSection.style.display = 'none';
    errorSection.style.display = 'none';
    progressSection.style.display = 'block';
    resetProgressSteps();
    resetExpandableSections();

    // Start step indicators
    const steps = [
        { id: 'step-1', text: 'Generating AI-powered name variations...', delay: 500 },
        { id: 'step-2', text: 'Filtering SDN entries...', delay: 2000 },
        { id: 'step-3', text: 'AI ranking and confidence scoring...', delay: 4000 },
        { id: 'step-4', text: 'Generating detailed explanations...', delay: 6000 }
    ];

    // Simulate progress steps
    steps.forEach((step, index) => {
        setTimeout(() => {
            updateStepStatus(step.id, 'in-progress', 'üîÑ');
            document.querySelector(`#${step.id} .step-text`).textContent = step.text;
        }, step.delay);
    });

    try {
        const response = await fetch('/search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                query: query,
                max_results: parseInt(maxResults)
            })
        });

        const data = await response.json();

        if (response.ok) {
            // Store step details for expandable sections
            currentStepDetails = data.step_details;

            // Mark all steps as complete
            completeAllSteps(data);
            setTimeout(() => {
                displayResults(data);
                populateStepDetails(data.step_details);
                resultsSection.style.display = 'block';
                progressSection.style.display = 'none';
            }, 1000);
        } else {
            markStepsAsError();
            showError(data.error || 'An error occurred');
        }
    } catch (error) {
        markStepsAsError();
        showError('Network error: Unable to connect to server');
    } finally {
        // Reset button state
        searchBtn.disabled = false;
        searchBtn.querySelector('.btn-text').style.display = 'inline';
        searchBtn.querySelector('.spinner').style.display = 'none';
    }
});

// Toggle expandable step details
function toggleStepDetails(stepId) {
    const details = document.getElementById(`${stepId}-details`);
    const icon = document.getElementById(`${stepId}-expand-icon`);

    if (details.style.display === 'none') {
        details.style.display = 'block';
        icon.textContent = '‚ñ≤';
        icon.classList.add('expanded');
    } else {
        details.style.display = 'none';
        icon.textContent = '‚ñº';
        icon.classList.remove('expanded');
    }
}

// Reset expandable sections
function resetExpandableSections() {
    ['step1', 'step2', 'step3'].forEach(stepId => {
        const details = document.getElementById(`${stepId}-details`);
        const icon = document.getElementById(`${stepId}-expand-icon`);
        if (details) details.style.display = 'none';
        if (icon) {
            icon.textContent = '‚ñº';
            icon.classList.remove('expanded');
        }
    });
}

// Populate step details from API response
function populateStepDetails(stepDetails) {
    if (!stepDetails) return;

    // Step 1: Name variations
    const step1 = stepDetails.step1_name_generation;
    if (step1) {
        const variationsContainer = document.getElementById('step1-variations');
        if (step1.variations && step1.variations.length > 0) {
            variationsContainer.innerHTML = step1.variations.map(v =>
                `<span class="variation-tag">${escapeHtml(v)}</span>`
            ).join('');
        } else {
            variationsContainer.innerHTML = '<p class="no-data">No variations generated</p>';
        }
    }

    // Step 2: Database filtering
    const step2 = stepDetails.step2_database_filtering;
    if (step2) {
        const statsContainer = document.getElementById('step2-stats');
        statsContainer.innerHTML = `
            <div class="stats-grid">
                <div class="stat-box">
                    <span class="stat-value">${step2.total_entries_searched?.toLocaleString() || 0}</span>
                    <span class="stat-label">Entries Searched</span>
                </div>
                <div class="stat-box">
                    <span class="stat-value">${(step2.threshold * 100).toFixed(0)}%</span>
                    <span class="stat-label">Match Threshold</span>
                </div>
                <div class="stat-box">
                    <span class="stat-value">${step2.matches_found || 0}</span>
                    <span class="stat-label">Matches Found</span>
                </div>
            </div>
        `;

        const matchesContainer = document.getElementById('step2-matches');
        if (step2.matches && step2.matches.length > 0) {
            matchesContainer.innerHTML = `
                <table class="details-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Match Score</th>
                            <th>Match Type</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${step2.matches.map(m => `
                            <tr>
                                <td>${escapeHtml(m.name)}</td>
                                <td><span class="type-badge">${escapeHtml(m.type)}</span></td>
                                <td><span class="score-badge">${(m.score * 100).toFixed(1)}%</span></td>
                                <td>${escapeHtml(m.match_type)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        } else {
            matchesContainer.innerHTML = '<p class="no-data">No matches found above threshold</p>';
        }
    }

    // Step 3: AI Ranking
    const step3 = stepDetails.step3_ai_ranking;
    if (step3) {
        const rankingContainer = document.getElementById('step3-ranking');
        if (step3.ranking_details && step3.ranking_details.length > 0) {
            rankingContainer.innerHTML = `
                <table class="details-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Name Score</th>
                            <th>Final Score</th>
                            <th>Confidence</th>
                            <th>Ranking Factors</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${step3.ranking_details.map(r => `
                            <tr>
                                <td>${escapeHtml(r.name)}</td>
                                <td><span class="score-badge">${(r.name_match_score * 100).toFixed(1)}%</span></td>
                                <td><span class="score-badge highlight">${(r.final_score * 100).toFixed(1)}%</span></td>
                                <td><span class="confidence-tag ${getConfidenceClass(r.confidence)}">${r.confidence}</span></td>
                                <td>
                                    <div class="reasons-list">
                                        ${r.match_reasons.map(reason =>
                                            `<span class="reason-tag">${escapeHtml(reason)}</span>`
                                        ).join('')}
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        } else {
            rankingContainer.innerHTML = '<p class="no-data">No ranking data available</p>';
        }
    }
}

function displayResults(data) {
    const resultsContainer = document.getElementById('results-container');
    
    if (!data.results || data.results.length === 0) {
        resultsContainer.innerHTML = '<p class="no-results">No matches found</p>';
        return;
    }
    
    const resultsHTML = data.results.map(match => {
        // Validate confidence level against score for consistency
        // If there's a mismatch, recalculate based on score
        let displayConfidence = match.confidence;
        const expectedConfidence = getConfidenceLevel(match.score);
        
        // Check for obvious mismatches (e.g., HIGH confidence with 0% score)
        if ((match.confidence === 'HIGH' && match.score <= 0.3) ||
            (match.confidence === 'LOW' && match.score > 0.8)) {
            displayConfidence = expectedConfidence;
        }
        
        return `
        <div class="result-card ${getConfidenceClass(displayConfidence)}">
            <div class="result-header">
                <h4 class="result-name">${escapeHtml(match.name)}</h4>
                <span class="confidence-badge ${getConfidenceClass(displayConfidence)}">
                    ${displayConfidence} (${(match.score * 100).toFixed(0)}%)
                </span>
            </div>
            
            <div class="result-details">
                <p><strong>Type:</strong> ${match.type}</p>
                ${match.details.dob ? `<p><strong>Date of Birth:</strong> ${match.details.dob}</p>` : ''}
                ${match.details.nationality ? `<p><strong>Nationality:</strong> ${match.details.nationality}</p>` : ''}
                ${match.details.program ? `<p><strong>Programs:</strong> ${match.details.program}</p>` : ''}
                <p><strong>UID:</strong> ${match.details.id}</p>
            </div>
            
            ${match.explanation ? `
                <div class="result-explanation">
                    <h5>Analysis</h5>
                    <pre style="white-space: pre-wrap; word-wrap: break-word; font-family: inherit; font-size: inherit; max-height: 400px; overflow-y: auto;">${escapeHtml(match.explanation)}</pre>
                </div>
            ` : ''}
            
            <div class="match-details">
                <h5>Match Details</h5>
                <ul>
                    <li><strong>Name Match Score:</strong> ${(match.name_match_score * 100).toFixed(1)}%</li>
                    <li><strong>Overall Score:</strong> ${(match.score * 100).toFixed(1)}%</li>
                    ${match.match_reasons ? match.match_reasons.map(reason => 
                        `<li>${escapeHtml(reason)}</li>`
                    ).join('') : ''}
                </ul>
            </div>
        </div>
    `}).join('');
    
    resultsContainer.innerHTML = resultsHTML;
}

function getConfidenceClass(confidence) {
    const level = confidence.toLowerCase().replace('-', '_');
    return `confidence-${level}`;
}

function getConfidenceLevel(score) {
    // Determine confidence level based on score if needed
    if (score > 0.8) return 'HIGH';
    if (score > 0.6) return 'MEDIUM-HIGH';
    if (score > 0.5) return 'MEDIUM';
    if (score > 0.3) return 'LOW-MEDIUM';
    return 'LOW';
}

function formatKey(key) {
    return key.split('_').map(word => 
        word.charAt(0).toUpperCase() + word.slice(1)
    ).join(' ');
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showError(message) {
    const errorSection = document.getElementById('error-section');
    const errorMessage = document.getElementById('error-message');
    errorMessage.textContent = message;
    errorSection.style.display = 'block';
    document.getElementById('progress-section').style.display = 'none';
}

function resetProgressSteps() {
    const steps = ['step-1', 'step-2', 'step-3', 'step-4'];
    steps.forEach(stepId => {
        updateStepStatus(stepId, 'pending', '‚è≥');
    });
}

function updateStepStatus(stepId, status, icon) {
    const step = document.getElementById(stepId);
    const statusSpan = step.querySelector('.step-status');
    step.className = `progress-step ${status}`;
    statusSpan.textContent = icon;
}

function completeAllSteps(data) {
    // Step 1: Name variations
    updateStepStatus('step-1', 'completed', '‚úÖ');
    document.querySelector('#step-1 .step-text').textContent = 'Generated AI name variations';
    
    // Step 2: Filtering
    updateStepStatus('step-2', 'completed', '‚úÖ');
    document.querySelector('#step-2 .step-text').textContent = `Filtered 17,991 entries`;
    
    // Step 3: Ranking
    updateStepStatus('step-3', 'completed', '‚úÖ');
    document.querySelector('#step-3 .step-text').textContent = `AI ranking completed - ${data.total_matches} matches found`;
    
    // Step 4: Explanations
    updateStepStatus('step-4', 'completed', '‚úÖ');
    const highConfidenceMatches = data.results ? data.results.filter(r => r.confidence === 'HIGH').length : 0;
    document.querySelector('#step-4 .step-text').textContent = `Generated ${highConfidenceMatches} detailed explanations`;
    
    // Update summary with actual results
    updateSummarySteps(data);
}

function updateSummarySteps(data) {
    const stepDetails = data.step_details || {};

    // Step 1 Summary: Name variations generated
    const step1 = stepDetails.step1_name_generation || {};
    const variationCount = step1.variation_count || 0;
    document.getElementById('summary-step1').textContent = `Generated ${variationCount} name variations for "${data.query}" (click to expand)`;

    // Step 2 Summary: Database filtering results
    const step2 = stepDetails.step2_database_filtering || {};
    const entriesSearched = step2.total_entries_searched || 0;
    const matchesFound = step2.matches_found || 0;
    document.getElementById('summary-step2').textContent = `Found ${matchesFound} potential matches from ${entriesSearched.toLocaleString()} SDN entries (click to expand)`;

    // Step 3 Summary: AI ranking and confidence analysis
    const highConf = data.results ? data.results.filter(r => r.confidence === 'HIGH').length : 0;
    const medHighConf = data.results ? data.results.filter(r => r.confidence === 'MEDIUM-HIGH').length : 0;
    const mediumConf = data.results ? data.results.filter(r => r.confidence === 'MEDIUM').length : 0;
    const lowConf = data.results ? data.results.filter(r => ['LOW', 'LOW-MEDIUM'].includes(r.confidence)).length : 0;
    document.getElementById('summary-step3').textContent = `AI ranked: ${highConf} high, ${medHighConf} med-high, ${mediumConf} medium, ${lowConf} low confidence (click to expand)`;

    // Step 4 Summary: Explanation generation
    const withExplanations = data.results ? data.results.filter(r => r.explanation && r.explanation.length > 0).length : 0;
    document.getElementById('summary-step4').textContent = `Generated detailed explanations for ${withExplanations} matches requiring further review`;
}

function markStepsAsError() {
    const steps = ['step-1', 'step-2', 'step-3', 'step-4'];
    steps.forEach(stepId => {
        const step = document.getElementById(stepId);
        if (!step.classList.contains('completed')) {
            updateStepStatus(stepId, 'error', '‚ùå');
        }
    });
}
</script>
{% endblock %}