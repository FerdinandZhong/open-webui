{% extends "base.html" %}

{% block content %}
<div class="search-section">
    <h2 class="section-title">Search SDN Watchlist</h2>
    <p class="section-description">
        Enter name, date of birth, nationality, or other identifying information to search the OFAC SDN list.
    </p>
    
    <form id="search-form" class="search-form">
        <div class="form-group">
            <label for="query">Search Query</label>
            <textarea 
                id="query" 
                name="query" 
                class="form-control" 
                rows="3" 
                placeholder="Example: John Smith, 01/15/1980, USA"
                required
            ></textarea>
        </div>
        
        <div class="form-group">
            <label for="max_results">Maximum Results</label>
            <input 
                type="number" 
                id="max_results" 
                name="max_results" 
                class="form-control" 
                value="10" 
                min="1" 
                max="50"
            >
        </div>
        
        <button type="submit" class="btn btn-primary" id="search-btn">
            <span class="btn-text">Search</span>
            <span class="spinner" style="display: none;"></span>
        </button>
    </form>
    
    <!-- Progress Status Section -->
    <div id="progress-section" class="progress-section" style="display: none;">
        <h3>Search Progress</h3>
        <div class="progress-steps">
            <div class="progress-step" id="step-1">
                <span class="step-number">1</span>
                <span class="step-text">Generating name variations...</span>
                <span class="step-status">‚è≥</span>
            </div>
            <div class="progress-step" id="step-2">
                <span class="step-number">2</span>
                <span class="step-text">Filtering potential matches...</span>
                <span class="step-status">‚è≥</span>
            </div>
            <div class="progress-step" id="step-3">
                <span class="step-number">3</span>
                <span class="step-text">AI-powered ranking...</span>
                <span class="step-status">‚è≥</span>
            </div>
            <div class="progress-step" id="step-4">
                <span class="step-number">4</span>
                <span class="step-text">Generating explanations...</span>
                <span class="step-status">‚è≥</span>
            </div>
        </div>
    </div>
</div>

<div id="results-section" class="results-section" style="display: none;">
    <h3 class="results-title">Search Results</h3>
    
    <!-- Processing Pipeline Visualization -->
    <div id="step-summary" class="pipeline-container">
        <div class="pipeline-header">
            <h4>Search Pipeline</h4>
            <div class="pipeline-actions">
                <button class="btn-expand-all" onclick="expandAllSteps()">Expand All</button>
                <button class="btn-collapse-all" onclick="collapseAllSteps()">Collapse All</button>
            </div>
        </div>

        <!-- Visual Timeline -->
        <div class="pipeline-timeline">
            <!-- Step 1: Name Generation -->
            <div class="pipeline-step" id="step1-container">
                <div class="step-indicator">
                    <div class="step-node completed">
                        <span class="step-icon">ü§ñ</span>
                    </div>
                    <div class="step-connector"></div>
                </div>
                <div class="step-card">
                    <div class="step-card-header" onclick="toggleStepDetails('step1')">
                        <div class="step-info">
                            <span class="step-badge">Step 1</span>
                            <h5>AI Name Generation</h5>
                            <p class="step-summary" id="summary-step1">Generated name variations</p>
                        </div>
                        <div class="step-metrics" id="step1-metrics">
                            <div class="metric">
                                <span class="metric-value" id="step1-count">-</span>
                                <span class="metric-label">Variations</span>
                            </div>
                        </div>
                        <button class="btn-details" aria-expanded="false">
                            <span class="btn-text">Details</span>
                            <svg class="chevron" viewBox="0 0 24 24" width="20" height="20">
                                <path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" fill="none"/>
                            </svg>
                        </button>
                    </div>
                    <div class="step-card-body" id="step1-details">
                        <div class="details-section">
                            <h6>Generated Name Variations</h6>
                            <p class="details-hint">These variations help find potential matches with different spellings or formats:</p>
                            <div class="variations-cloud" id="step1-variations">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Database Filtering -->
            <div class="pipeline-step" id="step2-container">
                <div class="step-indicator">
                    <div class="step-node completed">
                        <span class="step-icon">üîç</span>
                    </div>
                    <div class="step-connector"></div>
                </div>
                <div class="step-card">
                    <div class="step-card-header" onclick="toggleStepDetails('step2')">
                        <div class="step-info">
                            <span class="step-badge">Step 2</span>
                            <h5>Database Filtering</h5>
                            <p class="step-summary" id="summary-step2">Fuzzy matching against SDN list</p>
                        </div>
                        <div class="step-metrics" id="step2-metrics">
                            <div class="metric">
                                <span class="metric-value" id="step2-searched">-</span>
                                <span class="metric-label">Searched</span>
                            </div>
                            <div class="metric highlight">
                                <span class="metric-value" id="step2-found">-</span>
                                <span class="metric-label">Found</span>
                            </div>
                        </div>
                        <button class="btn-details" aria-expanded="false">
                            <span class="btn-text">Details</span>
                            <svg class="chevron" viewBox="0 0 24 24" width="20" height="20">
                                <path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" fill="none"/>
                            </svg>
                        </button>
                    </div>
                    <div class="step-card-body" id="step2-details">
                        <div class="details-section">
                            <div class="filter-overview">
                                <div class="overview-stat">
                                    <div class="stat-icon">üìä</div>
                                    <div class="stat-info">
                                        <span class="stat-number" id="step2-total">0</span>
                                        <span class="stat-text">Total Entries</span>
                                    </div>
                                </div>
                                <div class="overview-stat">
                                    <div class="stat-icon">üéØ</div>
                                    <div class="stat-info">
                                        <span class="stat-number" id="step2-threshold">70%</span>
                                        <span class="stat-text">Match Threshold</span>
                                    </div>
                                </div>
                                <div class="overview-stat success">
                                    <div class="stat-icon">‚úÖ</div>
                                    <div class="stat-info">
                                        <span class="stat-number" id="step2-matches-count">0</span>
                                        <span class="stat-text">Matches Found</span>
                                    </div>
                                </div>
                            </div>
                            <h6>Initial Matches</h6>
                            <div class="matches-list" id="step2-matches">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 3: AI Ranking -->
            <div class="pipeline-step" id="step3-container">
                <div class="step-indicator">
                    <div class="step-node completed">
                        <span class="step-icon">‚öñÔ∏è</span>
                    </div>
                    <div class="step-connector"></div>
                </div>
                <div class="step-card">
                    <div class="step-card-header" onclick="toggleStepDetails('step3')">
                        <div class="step-info">
                            <span class="step-badge">Step 3</span>
                            <h5>AI Ranking & Scoring</h5>
                            <p class="step-summary" id="summary-step3">Context-aware confidence scoring</p>
                        </div>
                        <div class="step-metrics" id="step3-metrics">
                            <div class="metric danger">
                                <span class="metric-value" id="step3-high">0</span>
                                <span class="metric-label">High</span>
                            </div>
                            <div class="metric warning">
                                <span class="metric-value" id="step3-medium">0</span>
                                <span class="metric-label">Medium</span>
                            </div>
                            <div class="metric success">
                                <span class="metric-value" id="step3-low">0</span>
                                <span class="metric-label">Low</span>
                            </div>
                        </div>
                        <button class="btn-details" aria-expanded="false">
                            <span class="btn-text">Details</span>
                            <svg class="chevron" viewBox="0 0 24 24" width="20" height="20">
                                <path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" fill="none"/>
                            </svg>
                        </button>
                    </div>
                    <div class="step-card-body" id="step3-details">
                        <div class="details-section">
                            <h6>Ranking Analysis</h6>
                            <p class="details-hint">Each match is scored based on name similarity, DOB, nationality, and other contextual factors:</p>
                            <div class="ranking-cards" id="step3-ranking">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 4: Explanation Generation -->
            <div class="pipeline-step" id="step4-container">
                <div class="step-indicator">
                    <div class="step-node completed">
                        <span class="step-icon">üìù</span>
                    </div>
                </div>
                <div class="step-card final">
                    <div class="step-card-header">
                        <div class="step-info">
                            <span class="step-badge">Step 4</span>
                            <h5>Explanation Generation</h5>
                            <p class="step-summary" id="summary-step4">AI-powered match explanations</p>
                        </div>
                        <div class="step-metrics">
                            <div class="metric">
                                <span class="metric-value" id="step4-explanations">0</span>
                                <span class="metric-label">Explanations</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="results-container"></div>
</div>

<div id="error-section" class="error-section" style="display: none;">
    <div class="error-message" id="error-message"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Store step details globally for expandable sections
let currentStepDetails = null;

document.getElementById('search-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const query = document.getElementById('query').value;
    const maxResults = document.getElementById('max_results').value;
    const searchBtn = document.getElementById('search-btn');
    const resultsSection = document.getElementById('results-section');
    const errorSection = document.getElementById('error-section');
    const progressSection = document.getElementById('progress-section');
    const resultsContainer = document.getElementById('results-container');

    // Show loading state and progress
    searchBtn.disabled = true;
    searchBtn.querySelector('.btn-text').style.display = 'none';
    searchBtn.querySelector('.spinner').style.display = 'inline-block';
    resultsSection.style.display = 'none';
    errorSection.style.display = 'none';
    progressSection.style.display = 'block';
    resetProgressSteps();
    resetExpandableSections();

    // Start step indicators
    const steps = [
        { id: 'step-1', text: 'Generating AI-powered name variations...', delay: 500 },
        { id: 'step-2', text: 'Filtering SDN entries...', delay: 2000 },
        { id: 'step-3', text: 'AI ranking and confidence scoring...', delay: 4000 },
        { id: 'step-4', text: 'Generating detailed explanations...', delay: 6000 }
    ];

    // Simulate progress steps
    steps.forEach((step, index) => {
        setTimeout(() => {
            updateStepStatus(step.id, 'in-progress', 'üîÑ');
            document.querySelector(`#${step.id} .step-text`).textContent = step.text;
        }, step.delay);
    });

    try {
        const response = await fetch('/search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                query: query,
                max_results: parseInt(maxResults)
            })
        });

        const data = await response.json();

        if (response.ok) {
            // Store step details for expandable sections
            currentStepDetails = data.step_details;

            // Mark all steps as complete
            completeAllSteps(data);
            setTimeout(() => {
                displayResults(data);
                populateStepDetails(data.step_details);
                resultsSection.style.display = 'block';
                progressSection.style.display = 'none';
            }, 1000);
        } else {
            markStepsAsError();
            showError(data.error || 'An error occurred');
        }
    } catch (error) {
        markStepsAsError();
        showError('Network error: Unable to connect to server');
    } finally {
        // Reset button state
        searchBtn.disabled = false;
        searchBtn.querySelector('.btn-text').style.display = 'inline';
        searchBtn.querySelector('.spinner').style.display = 'none';
    }
});

// Toggle expandable step details
function toggleStepDetails(stepId) {
    const details = document.getElementById(`${stepId}-details`);
    const card = document.getElementById(`${stepId}-container`);
    const btn = card?.querySelector('.btn-details');

    if (details.classList.contains('expanded')) {
        details.classList.remove('expanded');
        if (btn) btn.setAttribute('aria-expanded', 'false');
    } else {
        details.classList.add('expanded');
        if (btn) btn.setAttribute('aria-expanded', 'true');
    }
}

// Expand all steps
function expandAllSteps() {
    ['step1', 'step2', 'step3'].forEach(stepId => {
        const details = document.getElementById(`${stepId}-details`);
        const card = document.getElementById(`${stepId}-container`);
        const btn = card?.querySelector('.btn-details');
        if (details) details.classList.add('expanded');
        if (btn) btn.setAttribute('aria-expanded', 'true');
    });
}

// Collapse all steps
function collapseAllSteps() {
    ['step1', 'step2', 'step3'].forEach(stepId => {
        const details = document.getElementById(`${stepId}-details`);
        const card = document.getElementById(`${stepId}-container`);
        const btn = card?.querySelector('.btn-details');
        if (details) details.classList.remove('expanded');
        if (btn) btn.setAttribute('aria-expanded', 'false');
    });
}

// Reset expandable sections
function resetExpandableSections() {
    collapseAllSteps();
}

// Populate step details from API response
function populateStepDetails(stepDetails) {
    if (!stepDetails) return;

    // Step 1: Name variations
    const step1 = stepDetails.step1_name_generation;
    if (step1) {
        // Update metric
        document.getElementById('step1-count').textContent = step1.variation_count || 0;

        const variationsContainer = document.getElementById('step1-variations');
        if (step1.variations && step1.variations.length > 0) {
            variationsContainer.innerHTML = step1.variations.map(v =>
                `<span class="variation-chip">${escapeHtml(v)}</span>`
            ).join('');
        } else {
            variationsContainer.innerHTML = '<p class="no-data">No variations generated</p>';
        }
    }

    // Step 2: Database filtering
    const step2 = stepDetails.step2_database_filtering;
    if (step2) {
        // Update metrics
        document.getElementById('step2-searched').textContent = formatNumber(step2.total_entries_searched || 0);
        document.getElementById('step2-found').textContent = step2.matches_found || 0;

        // Update overview stats
        document.getElementById('step2-total').textContent = formatNumber(step2.total_entries_searched || 0);
        document.getElementById('step2-threshold').textContent = `${(step2.threshold * 100).toFixed(0)}%`;
        document.getElementById('step2-matches-count').textContent = step2.matches_found || 0;

        const matchesContainer = document.getElementById('step2-matches');
        if (step2.matches && step2.matches.length > 0) {
            matchesContainer.innerHTML = step2.matches.map(m => `
                <div class="match-item">
                    <div class="match-item-info">
                        <span class="match-item-name">${escapeHtml(m.name)}</span>
                        <span class="match-item-type">${escapeHtml(m.type)}</span>
                    </div>
                    <span class="match-item-score">${(m.score * 100).toFixed(1)}%</span>
                </div>
            `).join('');
        } else {
            matchesContainer.innerHTML = '<p class="no-data">No matches found above threshold</p>';
        }
    }

    // Step 3: AI Ranking
    const step3 = stepDetails.step3_ai_ranking;
    if (step3 && step3.ranking_details) {
        // Update metrics
        const highCount = step3.ranking_details.filter(r => r.confidence === 'HIGH').length;
        const medCount = step3.ranking_details.filter(r => ['MEDIUM', 'MEDIUM-HIGH'].includes(r.confidence)).length;
        const lowCount = step3.ranking_details.filter(r => ['LOW', 'LOW-MEDIUM'].includes(r.confidence)).length;

        document.getElementById('step3-high').textContent = highCount;
        document.getElementById('step3-medium').textContent = medCount;
        document.getElementById('step3-low').textContent = lowCount;

        const rankingContainer = document.getElementById('step3-ranking');
        if (step3.ranking_details.length > 0) {
            rankingContainer.innerHTML = step3.ranking_details.map(r => `
                <div class="ranking-card">
                    <div class="ranking-card-header">
                        <span class="ranking-card-name">${escapeHtml(r.name)}</span>
                        <span class="ranking-card-confidence ${getConfidenceClass(r.confidence).replace('confidence-', '')}">${r.confidence}</span>
                    </div>
                    <div class="ranking-card-body">
                        <div class="ranking-scores">
                            <div class="ranking-score">
                                <span class="ranking-score-label">Name Match</span>
                                <span class="ranking-score-value">${(r.name_match_score * 100).toFixed(1)}%</span>
                            </div>
                            <div class="ranking-score">
                                <span class="ranking-score-label">Final Score</span>
                                <span class="ranking-score-value final">${(r.final_score * 100).toFixed(1)}%</span>
                            </div>
                        </div>
                        <div class="ranking-factors">
                            ${r.match_reasons.map(reason =>
                                `<span class="factor-tag">${escapeHtml(reason)}</span>`
                            ).join('')}
                        </div>
                    </div>
                </div>
            `).join('');
        } else {
            rankingContainer.innerHTML = '<p class="no-data">No ranking data available</p>';
        }
    }
}

// Format large numbers
function formatNumber(num) {
    if (num >= 1000) {
        return (num / 1000).toFixed(1) + 'K';
    }
    return num.toString();
}

function displayResults(data) {
    const resultsContainer = document.getElementById('results-container');
    
    if (!data.results || data.results.length === 0) {
        resultsContainer.innerHTML = '<p class="no-results">No matches found</p>';
        return;
    }
    
    const resultsHTML = data.results.map(match => {
        // Validate confidence level against score for consistency
        // If there's a mismatch, recalculate based on score
        let displayConfidence = match.confidence;
        const expectedConfidence = getConfidenceLevel(match.score);
        
        // Check for obvious mismatches (e.g., HIGH confidence with 0% score)
        if ((match.confidence === 'HIGH' && match.score <= 0.3) ||
            (match.confidence === 'LOW' && match.score > 0.8)) {
            displayConfidence = expectedConfidence;
        }
        
        return `
        <div class="result-card ${getConfidenceClass(displayConfidence)}">
            <div class="result-header">
                <h4 class="result-name">${escapeHtml(match.name)}</h4>
                <span class="confidence-badge ${getConfidenceClass(displayConfidence)}">
                    ${displayConfidence} (${(match.score * 100).toFixed(0)}%)
                </span>
            </div>
            
            <div class="result-details">
                <p><strong>Type:</strong> ${match.type}</p>
                ${match.details.dob ? `<p><strong>Date of Birth:</strong> ${match.details.dob}</p>` : ''}
                ${match.details.nationality ? `<p><strong>Nationality:</strong> ${match.details.nationality}</p>` : ''}
                ${match.details.program ? `<p><strong>Programs:</strong> ${match.details.program}</p>` : ''}
                <p><strong>UID:</strong> ${match.details.id}</p>
            </div>
            
            ${match.explanation ? `
                <div class="result-explanation">
                    <h5>Analysis</h5>
                    <pre style="white-space: pre-wrap; word-wrap: break-word; font-family: inherit; font-size: inherit; max-height: 400px; overflow-y: auto;">${escapeHtml(match.explanation)}</pre>
                </div>
            ` : ''}
            
            <div class="match-details">
                <h5>Match Details</h5>
                <ul>
                    <li><strong>Name Match Score:</strong> ${(match.name_match_score * 100).toFixed(1)}%</li>
                    <li><strong>Overall Score:</strong> ${(match.score * 100).toFixed(1)}%</li>
                    ${match.match_reasons ? match.match_reasons.map(reason => 
                        `<li>${escapeHtml(reason)}</li>`
                    ).join('') : ''}
                </ul>
            </div>
        </div>
    `}).join('');
    
    resultsContainer.innerHTML = resultsHTML;
}

function getConfidenceClass(confidence) {
    const level = confidence.toLowerCase().replace('-', '_');
    return `confidence-${level}`;
}

function getConfidenceLevel(score) {
    // Determine confidence level based on score if needed
    if (score > 0.8) return 'HIGH';
    if (score > 0.6) return 'MEDIUM-HIGH';
    if (score > 0.5) return 'MEDIUM';
    if (score > 0.3) return 'LOW-MEDIUM';
    return 'LOW';
}

function formatKey(key) {
    return key.split('_').map(word => 
        word.charAt(0).toUpperCase() + word.slice(1)
    ).join(' ');
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showError(message) {
    const errorSection = document.getElementById('error-section');
    const errorMessage = document.getElementById('error-message');
    errorMessage.textContent = message;
    errorSection.style.display = 'block';
    document.getElementById('progress-section').style.display = 'none';
}

function resetProgressSteps() {
    const steps = ['step-1', 'step-2', 'step-3', 'step-4'];
    steps.forEach(stepId => {
        updateStepStatus(stepId, 'pending', '‚è≥');
    });
}

function updateStepStatus(stepId, status, icon) {
    const step = document.getElementById(stepId);
    const statusSpan = step.querySelector('.step-status');
    step.className = `progress-step ${status}`;
    statusSpan.textContent = icon;
}

function completeAllSteps(data) {
    // Step 1: Name variations
    updateStepStatus('step-1', 'completed', '‚úÖ');
    document.querySelector('#step-1 .step-text').textContent = 'Generated AI name variations';
    
    // Step 2: Filtering
    updateStepStatus('step-2', 'completed', '‚úÖ');
    document.querySelector('#step-2 .step-text').textContent = `Filtered 17,991 entries`;
    
    // Step 3: Ranking
    updateStepStatus('step-3', 'completed', '‚úÖ');
    document.querySelector('#step-3 .step-text').textContent = `AI ranking completed - ${data.total_matches} matches found`;
    
    // Step 4: Explanations
    updateStepStatus('step-4', 'completed', '‚úÖ');
    const highConfidenceMatches = data.results ? data.results.filter(r => r.confidence === 'HIGH').length : 0;
    document.querySelector('#step-4 .step-text').textContent = `Generated ${highConfidenceMatches} detailed explanations`;
    
    // Update summary with actual results
    updateSummarySteps(data);
}

function updateSummarySteps(data) {
    const stepDetails = data.step_details || {};

    // Step 1 Summary
    const step1 = stepDetails.step1_name_generation || {};
    const variationCount = step1.variation_count || 0;
    document.getElementById('summary-step1').textContent = `Generated ${variationCount} variations for "${data.query}"`;

    // Step 2 Summary
    const step2 = stepDetails.step2_database_filtering || {};
    const matchesFound = step2.matches_found || 0;
    document.getElementById('summary-step2').textContent = `Found ${matchesFound} potential matches`;

    // Step 3 Summary
    document.getElementById('summary-step3').textContent = `Analyzed ${data.total_matches || 0} matches with AI`;

    // Step 4 Summary
    const withExplanations = data.results ? data.results.filter(r => r.explanation && r.explanation.length > 0).length : 0;
    document.getElementById('summary-step4').textContent = `${withExplanations} detailed explanations generated`;
    document.getElementById('step4-explanations').textContent = withExplanations;
}

function markStepsAsError() {
    const steps = ['step-1', 'step-2', 'step-3', 'step-4'];
    steps.forEach(stepId => {
        const step = document.getElementById(stepId);
        if (!step.classList.contains('completed')) {
            updateStepStatus(stepId, 'error', '‚ùå');
        }
    });
}
</script>
{% endblock %}